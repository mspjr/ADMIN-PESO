<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Job Skills Assignment | SKILLocal Admin</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="jobskillsass.css" />
</head>

<body class="dashboard-body">

  <aside class="sidebar">
    <h2 class="logo">SKILlocal</h2>
    <nav class="navbar flex-column">
      <ul class="navbar-nav w-100">

        <li class="nav-item">
          <a href="dashboard.html" class="nav-link toggle-menu">
            ‚öôÔ∏è Master Data
            <i class="fa-solid fa-chevron-down ms-auto"></i>
          </a>
          <ul class="submenu list-unstyled ms-3 show">
            <li><a class="submenu-item" href="barangay.html">üèò Barangay</a></li>
            <li><a class="submenu-item" href="establishments.html">üè¢ Establishment</a></li>
            <li><a class="submenu-item" href="industry.html">üè≠ Industry</a></li>
            <li><a class="submenu-item" href="skilledjob.html">üßë‚Äçüîß Skilled Job</a></li>
            <li><a class="submenu-item" href="skills.html">üß∞ Skills</a></li>
          </ul>
        </li>

        <li class="nav-item">
          <a href="#" class="nav-link toggle-menu">
            üß© Data Assignment
            <i class="fa-solid fa-chevron-down ms-auto"></i>
          </a>
          <ul class="submenu list-unstyled ms-3">
            <li><a class="submenu-item" href="industryass.html">üè≠ Industry Job Assignment</a></li>
            <li><a class="submenu-item active" href="jobskillsass.html">üß∞ Job Skills Assignment</a></li>
          </ul>
        </li>

        <li class="nav-item"><a href="users.html" class="nav-link">üë• Users</a></li>
        <li class="nav-item"><a href="matching.html" class="nav-link">üîç Job Matching</a></li>
        <li class="nav-item"><a href="vacancies.html" class="nav-link">üíº Job Vacancies</a></li>
        <li class="nav-item"><a href="applications.html" class="nav-link">üìÑ Applications</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <div>
        <h1>üß∞ Job Skills Assignment</h1>
        <p>Manage job skills assignments for skilled workers.</p>
      </div>

      <div class="profile-container">
        <img src="image.jpg" alt="Profile" id="profile-icon" onclick="toggleProfileMenu()">
        <div id="profile-menu" class="profile-menu">
          <ul>
            <li><a href="profile.html">üë§ Profile</a></li>
            <li><a href="index.html"><i class="fa fa-sign-out-alt"></i> Logout</a></li>
          </ul>
        </div>
      </div>
    </header>

    <div class="row g-3">

      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Job Roles</strong>
              <div class="small text-muted">Base job titles used in matching.</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="btnAddJob">
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblJobs">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Job Title</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Skills</strong>
              <div class="small text-muted">Reusable skill library.</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="btnAddSkill">
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblSkills">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Skill</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Job ‚áÑ Skill Assignments</strong>
              <div class="small text-muted">Which skills belong to each job.</div>
            </div>
            <button class="btn btn-sm btn-primary assign-btn" id="btnAddAssign">
              <i class="bi bi-link-45deg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblAssignments">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Job Role</th>
                    <th>Skill</th>
                    <th>Proficiency</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

    <div class="modal fade" id="modalJob" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formJob">
          <div class="modal-header">
            <h5 class="modal-title">Add Job Role</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="jobId">
            <div class="mb-3">
              <label class="form-label">Job Title</label>
              <input class="form-control" id="jobTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-control" id="jobDesc" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalSkill" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formSkill">
          <div class="modal-header">
            <h5 class="modal-title">Add Skill</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="skillId">
            <div class="mb-3">
              <label class="form-label">Skill Name</label>
              <input class="form-control" id="skillName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-control" id="skillDesc" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalAssign" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formAssign">
          <div class="modal-header">
            <h5 class="modal-title">Add Job ‚áÑ Skill Assignment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="assignId">
            <div class="mb-3">
              <label class="form-label">Job Role</label>
              <select class="form-select" id="assignJob" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Skill</label>
              <select class="form-select" id="assignSkill" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Proficiency</label>
              <input class="form-control" id="assignProficiency" required>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>


  <script>
    function toggleProfileMenu() {
      const profileMenu = document.getElementById('profile-menu');
      profileMenu.classList.toggle('show');
    }

    document.querySelectorAll('.toggle-menu').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const submenu = btn.nextElementSibling;
        document.querySelectorAll('.submenu').forEach(list => {
          if (list !== submenu) list.classList.remove('show');
        });
        submenu.classList.toggle('show');
      });
    });

    const STORE_KEYS = {
      jobs:       'skillocal_js_jobs',
      skills:     'skillocal_js_skills',
      assigns:    'skillocal_js_assigns',
      idCounters: 'skillocal_js_idcounters'
    };

    const defaultData = {
      jobs: [],
      skills: [],
      assigns: [],
      idCounters: { job: 0, skill: 0, assign: 0 }
    };

    function loadStore() {
      const jobsRaw     = JSON.parse(localStorage.getItem(STORE_KEYS.jobs));
      const skillsRaw   = JSON.parse(localStorage.getItem(STORE_KEYS.skills));
      const assignsRaw  = JSON.parse(localStorage.getItem(STORE_KEYS.assigns));
      const ctrRaw      = JSON.parse(localStorage.getItem(STORE_KEYS.idCounters));

      let jobs       = jobsRaw     || defaultData.jobs;
      let skills     = skillsRaw   || defaultData.skills;
      let assigns    = assignsRaw  || defaultData.assigns;
      let idCounters = ctrRaw      || defaultData.idCounters;

      jobs    = jobs.filter(j   => j && j.id   != null);
      skills  = skills.filter(s => s && s.id   != null);
      assigns = assigns.filter(a => a && a.id != null);

      return { jobs, skills, assigns, idCounters };
    }

    function saveStore({ jobs, skills, assigns, idCounters }) {
      localStorage.setItem(STORE_KEYS.jobs,       JSON.stringify(jobs));
      localStorage.setItem(STORE_KEYS.skills,     JSON.stringify(skills));
      localStorage.setItem(STORE_KEYS.assigns,    JSON.stringify(assigns));
      localStorage.setItem(STORE_KEYS.idCounters, JSON.stringify(idCounters));
    }

    let state = loadStore();

    const byId = id => document.getElementById(id);
    const modalJob    = new bootstrap.Modal('#modalJob');
    const modalSkill  = new bootstrap.Modal('#modalSkill');
    const modalAssign = new bootstrap.Modal('#modalAssign');

    function displayId(val) {
      return (val === null || val === undefined || Number.isNaN(val)) ? '' : val;
    }

    function jobTitle(id) {
      return (state.jobs.find(j => j.id === id) || {}).title || '‚Äî';
    }

    function skillName(id) {
      return (state.skills.find(s => s.id === id) || {}).name || '‚Äî';
    }

    function renderJobOptions(selectEl) {
      selectEl.innerHTML = '';
      state.jobs.forEach(job => {
        const opt = document.createElement('option');
        opt.value = job.id;
        opt.textContent = job.title;
        selectEl.appendChild(opt);
      });
    }

    function renderSkillOptions(selectEl) {
      selectEl.innerHTML = '';
      state.skills.forEach(skill => {
        const opt = document.createElement('option');
        opt.value = skill.id;
        opt.textContent = skill.name;
        selectEl.appendChild(opt);
      });
    }

    function renderJobsTable() {
      const tbody = byId('tblJobs').querySelector('tbody');
      tbody.innerHTML = '';
      state.jobs.forEach(job => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${displayId(job.id)}</td>
          <td>
            <div class="fw-semibold">${job.title}</div>
            <div class="text-muted small">${job.desc || ''}</div>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${job.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${job.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderSkillsTable() {
      const tbody = byId('tblSkills').querySelector('tbody');
      tbody.innerHTML = '';
      state.skills.forEach(skill => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${displayId(skill.id)}</td>
          <td>${skill.name}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${skill.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${skill.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAssignmentsTable() {
      const tbody = byId('tblAssignments').querySelector('tbody');
      tbody.innerHTML = '';
      state.assigns.forEach(assign => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${displayId(assign.id)}</td>
          <td>${jobTitle(assign.jobId)}</td>
          <td>${skillName(assign.skillId)}</td>
          <td>${assign.proficiency}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${assign.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${assign.id}">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    byId('btnAddJob').addEventListener('click', () => {
      byId('jobId').value = '';
      byId('jobTitle').value = '';
      byId('jobDesc').value = '';
      byId('modalJob').querySelector('.modal-title').textContent = 'Add Job Role';
      modalJob.show();
    });

    byId('formJob').addEventListener('submit', (e) => {
      e.preventDefault();
      const id   = byId('jobId').value;
      const title = byId('jobTitle').value.trim();
      const desc  = byId('jobDesc').value.trim();
      if (!title) return;

      if (id) {
        const idx = state.jobs.findIndex(j => j.id === Number(id));
        if (idx >= 0) {
          state.jobs[idx].title = title;
          state.jobs[idx].desc  = desc;
        }
      } else {
        state.idCounters.job += 1;
        const newId = state.idCounters.job;
        state.jobs.push({ id: newId, title, desc });
      }
      saveStore(state);
      renderJobsTable();
      renderAssignmentsTable();
      modalJob.hide();
    });

    byId('tblJobs').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') {
        const job = state.jobs.find(j => j.id === id);
        if (!job) return;
        byId('jobId').value = job.id;
        byId('jobTitle').value = job.title;
        byId('jobDesc').value  = job.desc || '';
        byId('modalJob').querySelector('.modal-title').textContent = 'Edit Job Role';
        modalJob.show();
      }
      if (action === 'del') {
        if (!confirm('Delete this job role?')) return;
        state.jobs = state.jobs.filter(j => j.id !== id);
        saveStore(state);
        renderJobsTable();
        renderAssignmentsTable();
      }
    });

    byId('btnAddSkill').addEventListener('click', () => {
      byId('skillId').value = '';
      byId('skillName').value = '';
      byId('skillDesc').value = '';
      byId('modalSkill').querySelector('.modal-title').textContent = 'Add Skill';
      modalSkill.show();
    });

    byId('formSkill').addEventListener('submit', (e) => {
      e.preventDefault();
      const id   = byId('skillId').value;
      const name = byId('skillName').value.trim();
      const desc = byId('skillDesc').value.trim();
      if (!name) return;

      if (id) {
        const idx = state.skills.findIndex(s => s.id === Number(id));
        if (idx >= 0) {
          state.skills[idx].name = name;
          state.skills[idx].desc = desc;
        }
      } else {
        state.idCounters.skill += 1;
        const newId = state.idCounters.skill;
        state.skills.push({ id: newId, name, desc });
      }
      saveStore(state);
      renderSkillsTable();
      renderAssignmentsTable();
      modalSkill.hide();
    });

    byId('tblSkills').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') {
        const skill = state.skills.find(s => s.id === id);
        if (!skill) return;
        byId('skillId').value   = skill.id;
        byId('skillName').value = skill.name;
        byId('skillDesc').value = skill.desc || '';
        byId('modalSkill').querySelector('.modal-title').textContent = 'Edit Skill';
        modalSkill.show();
      }
      if (action === 'del') {
        if (!confirm('Delete this skill?')) return;
        state.skills = state.skills.filter(s => s.id !== id);
        saveStore(state);
        renderSkillsTable();
        renderAssignmentsTable();
      }
    });

    function openAssignModal(editId = null) {
      renderJobOptions(byId('assignJob'));
      renderSkillOptions(byId('assignSkill'));

      byId('assignId').value = '';
      byId('assignProficiency').value = '';
      byId('modalAssign').querySelector('.modal-title').textContent =
        editId ? 'Edit Job ‚áÑ Skill Assignment' : 'Add Job ‚áÑ Skill Assignment';

      if (editId) {
        const rec = state.assigns.find(a => a.id === editId);
        if (!rec) return;
        byId('assignJob').value         = rec.jobId;
        byId('assignSkill').value       = rec.skillId;
        byId('assignProficiency').value = rec.proficiency;
        byId('assignId').value          = rec.id;
      }
      modalAssign.show();
    }

    byId('btnAddAssign').addEventListener('click', () => openAssignModal());

    byId('formAssign').addEventListener('submit', (e) => {
      e.preventDefault();
      const idVal        = byId('assignId').value;
      const jobId        = Number(byId('assignJob').value);
      const skillId      = Number(byId('assignSkill').value);
      const proficiency  = byId('assignProficiency').value.trim();
      if (!proficiency) return;

      const dup = state.assigns.find(a =>
        a.jobId === jobId &&
        a.skillId === skillId &&
        a.id !== Number(idVal || 0)
      );
      if (dup) {
        alert('This Job ‚áÑ Skill link already exists.');
        return;
      }

      if (idVal) {
        const idx = state.assigns.findIndex(a => a.id === Number(idVal));
        if (idx >= 0) {
          state.assigns[idx].jobId       = jobId;
          state.assigns[idx].skillId     = skillId;
          state.assigns[idx].proficiency = proficiency;
        }
      } else {
        state.idCounters.assign += 1;
        const newId = state.idCounters.assign;
        state.assigns.push({
          id: newId,
          jobId,
          skillId,
          proficiency
        });
      }
      saveStore(state);
      renderAssignmentsTable();
      modalAssign.hide();
    });

    byId('tblAssignments').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') openAssignModal(id);
      if (action === 'del') {
        if (!confirm('Delete this assignment?')) return;
        state.assigns = state.assigns.filter(a => a.id !== id);
        saveStore(state);
        renderAssignmentsTable();
      }
    });

    (function init() {
      renderJobsTable();
      renderSkillsTable();
      renderAssignmentsTable();
    })();
  </script>

</body>
</html>
