<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Establishments | SKILLocal Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="establishments.css" />
</head>

<body class="dashboard-body">
  
  <aside class="sidebar">
    <h2 class="logo">SKILlocal</h2>
    <nav>
      <a href="dashboard.html">ğŸ“Š Dashboard</a>
      <a href="users.html">ğŸ‘¥ Users</a>
      <a href="establishments.html" class="active">ğŸ¢ Establishments</a>
      <a href="vacancies.html">ğŸ’¼ Job Vacancies</a>
      <a href="applications.html">ğŸ“„ Applications</a>
      <a href="matching.html">ğŸ” Matching</a>
      <a href="masterdata.html">âš™ï¸ Master Data</a>
      <a href="profile.html">ğŸ‘¤ Profile</a>
      <a href="login.html" class="logout">Logout</a>
    </nav>
  </aside>

  
  <main class="main-content">
    <header class="header">
      <div>
        <h1>ğŸ¢ Establishment Management</h1>
        <p>View, verify, and manage business establishments in General Santos City.</p>
      </div>
      <div class="timestamp" id="timestamp"></div>
    </header>

    
    <div class="top-controls">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search establishment..." />
      </div>
      <button class="btn-add" id="openModalBtn">
        <i class="bi bi-plus-circle"></i> Add Establishment
      </button>
    </div>

    
    <section class="users-section">
      <div class="card">
        <h3>Establishment List</h3>
        <div class="table-container">
          <table id="establishmentTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Establishment Name</th>
                <th>Owner / Contact</th>
                <th>Email</th>
                <th>Industry</th>
                <th>Status</th>
                <th>Date Registered</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  
  <div id="addModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="bi bi-building-add"></i> Add Establishment</h2>
        <span class="close-btn" id="closeModalBtn">&times;</span>
      </div>

      <form id="addEstablishmentForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="establishmentName">Establishment Name</label>
            <input type="text" id="establishmentName" name="establishmentName" required />
          </div>
          <div class="form-group">
            <label for="ownerName">Owner / Contact Person</label>
            <input type="text" id="ownerName" name="ownerName" required />
          </div>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" name="email" required />
          </div>
          <div class="form-group">
            <label for="contactNumber">Contact Number</label>
            <input type="text" id="contactNumber" name="contactNumber" required />
          </div>
          <div class="form-group">
            <label for="industry">Industry Type</label>
            <select id="industry" name="industry" required>
              <option value="">Select Industry</option>
              <option>Construction</option>
              <option>Manufacturing</option>
              <option>Technology</option>
              <option>Retail</option>
              <option>Food & Beverage</option>
              <option>Services</option>
              <option>Others</option>
            </select>
          </div>
          <div class="form-group">
            <label for="address">Business Address</label>
            <textarea id="address" name="address" rows="3" required></textarea>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelModalBtn">Cancel</button>
          <button type="submit" class="btn-save">Save Establishment</button>
        </div>
      </form>
    </div>
  </div>

  
  <div id="viewModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ‘ï¸ View Establishment</h2>
        <span class="close-btn" id="closeViewBtn">&times;</span>
      </div>
      <div class="view-body" id="viewBody" style="color:#333; line-height:1.6;"></div>
      <div class="modal-actions">
        <button class="btn-save" id="viewCloseBtn">Close</button>
      </div>
    </div>
  </div>

  
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœï¸ Edit Establishment</h2>
        <span class="close-btn" id="closeEditBtn">&times;</span>
      </div>

      <form id="editForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="editName">Establishment Name</label>
            <input type="text" id="editName" name="editName" required />
          </div>
          <div class="form-group">
            <label for="editOwner">Owner / Contact Person</label>
            <input type="text" id="editOwner" name="editOwner" required />
          </div>
          <div class="form-group">
            <label for="editEmail">Email Address</label>
            <input type="email" id="editEmail" name="editEmail" required />
          </div>
          <div class="form-group">
            <label for="editContact">Contact Number</label>
            <input type="text" id="editContact" name="editContact" required />
          </div>
          <div class="form-group">
            <label for="editIndustry">Industry Type</label>
            <select id="editIndustry" name="editIndustry" required>
              <option value="">Select Industry</option>
              <option>Construction</option>
              <option>Manufacturing</option>
              <option>Technology</option>
              <option>Retail</option>
              <option>Food & Beverage</option>
              <option>Services</option>
              <option>Others</option>
            </select>
          </div>
          <div class="form-group">
            <label for="editAddress">Business Address</label>
            <textarea id="editAddress" name="editAddress" rows="3" required></textarea>
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" id="cancelEditBtn">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ—‘ï¸ Delete Establishment</h2>
        <span class="close-btn" id="closeDeleteBtn">&times;</span>
      </div>
      <div id="deleteBody" style="color:#333;"></div>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancelDeleteBtn">Cancel</button>
        <button class="btn-save" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  
  <div id="verifyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœ… Verify Establishment</h2>
        <span class="close-btn" id="closeVerifyBtn">&times;</span>
      </div>
      <div id="verifyBody" style="color:#333;"></div>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancelVerifyBtn">Cancel</button>
        <button class="btn-save" id="confirmVerifyBtn">Verify</button>
      </div>
    </div>
  </div>

  
  <script>
    
    function updateTimestamp() {
      const now = new Date();
      document.getElementById("timestamp").textContent =
        now.toLocaleString("en-PH", { dateStyle: "full", timeStyle: "medium" });
    }
    setInterval(updateTimestamp, 1000);
    updateTimestamp();

    
    const LS_KEY = "skillocal_establishments_v1";

    function formatDate(dateObj) {
      return dateObj.toLocaleDateString('en-PH', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getData() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }

    function saveData(arr) {
      localStorage.setItem(LS_KEY, JSON.stringify(arr));
    }

  
    const tbody = document.querySelector("#establishmentTable tbody");

    function renderTable() {
      const list = getData();
      
      tbody.innerHTML = "";
      list.forEach((item, idx) => {
        const tr = document.createElement("tr");
        tr.dataset.id = item.id;
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(item.name)}</td>
          <td>${escapeHtml(item.owner)}</td>
          <td>${escapeHtml(item.email)}</td>
          <td>${escapeHtml(item.industry)}</td>
          <td>${item.status === 'Verified' ? '<span class="badge active">Verified</span>' : '<span class="badge pending">Pending</span>'}</td>
          <td>${escapeHtml(item.dateRegistered)}</td>
          <td class="action-icons">
            <i class="bi bi-eye-fill icon-view" title="View"></i>
            <i class="bi bi-pencil-square icon-edit" title="Edit"></i>
            <i class="bi bi-trash-fill icon-delete" title="Delete"></i>
            <i class="bi bi-check-circle icon-verify" title="Verify"></i>
          </td>
        `;
        tbody.appendChild(tr);
        attachRowListeners(tr);
      });
    }

    
    function escapeHtml(str) {
      if (!str && str !== 0) return "";
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    
    (function ensureInitial() {
      const current = getData();
      if (current.length === 0) {
        const sample = [{
          id: 'sample-1',
          name: 'ABC Builders',
          owner: 'Juan Dela Cruz',
          email: 'abcbuilders@gmail.com',
          industry: 'Construction',
          contactNumber: '',
          address: '',
          status: 'Verified',
          dateRegistered: 'Sep 28, 2025'
        }];
        saveData(sample);
      }
      renderTable();
    })();

    
    const searchInput = document.getElementById("searchInput");
    searchInput.addEventListener("keyup", () => {
      const filter = searchInput.value.toLowerCase();
      const rows = tbody.getElementsByTagName("tr");
      for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let match = false;
        for (let j = 0; j < cells.length - 1; j++) {
          if (cells[j].textContent.toLowerCase().includes(filter)) {
            match = true;
            break;
          }
        }
        rows[i].style.display = match ? "" : "none";
      }
    });

    
    function openModal(modalEl) { modalEl.style.display = "flex"; }
    function closeModal(modalEl) { modalEl.style.display = "none"; }

    
    const addModal = document.getElementById("addModal");
    const openBtn = document.getElementById("openModalBtn");
    const closeBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelModalBtn");

    openBtn.onclick = () => openModal(addModal);
    closeBtn.onclick = cancelBtn.onclick = () => closeModal(addModal);
    window.addEventListener("click", (e) => {
      if (e.target === addModal) closeModal(addModal);
      
      ['viewModal','editModal','deleteModal','verifyModal'].forEach(id => {
        const mm = document.getElementById(id);
        if (e.target === mm) closeModal(mm);
      });
    });

    
    const addForm = document.getElementById("addEstablishmentForm");
    addForm.addEventListener("input", () => {
      const data = {};
      Array.from(addForm.elements).forEach(el => {
        if (el.name) data[el.name] = el.value;
      });
      localStorage.setItem("establishmentFormData", JSON.stringify(data));
    });
   
    window.addEventListener("load", () => {
      const saved = JSON.parse(localStorage.getItem("establishmentFormData") || "{}");
      for (const key in saved) {
        if (addForm.elements[key]) addForm.elements[key].value = saved[key];
      }
    });

    
    addForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const name = addForm.establishmentName.value.trim();
      const owner = addForm.ownerName.value.trim();
      const email = addForm.email.value.trim();
      const contactNumber = addForm.contactNumber.value.trim();
      const industry = addForm.industry.value;
      const address = addForm.address.value.trim();

      const now = new Date();
      const item = {
        id: 'id-' + Date.now(),
        name, owner, email, contactNumber, industry, address,
        status: 'Pending',
        dateRegistered: formatDate(now)
      };

      const arr = getData();
      arr.push(item);
      saveData(arr);
      
      localStorage.removeItem("establishmentFormData");
      addForm.reset();
      closeModal(addModal);
      renderTable();
    });

    
    function attachRowListeners(tr) {
      const viewBtn = tr.querySelector(".icon-view");
      const editBtn = tr.querySelector(".icon-edit");
      const delBtn = tr.querySelector(".icon-delete");
      const verifyBtn = tr.querySelector(".icon-verify");

      const id = tr.dataset.id;

      viewBtn.onclick = () => openView(id);
      editBtn.onclick = () => openEdit(id);
      delBtn.onclick = () => openDelete(id);
      verifyBtn.onclick = () => openVerify(id);
    }

    
    const viewModal = document.getElementById("viewModal");
    const closeViewBtn = document.getElementById("closeViewBtn");
    const viewCloseBtn = document.getElementById("viewCloseBtn");
    closeViewBtn.onclick = viewCloseBtn.onclick = () => closeModal(viewModal);

    function openView(id) {
      const list = getData();
      const item = list.find(x => x.id === id);
      if (!item) return;
      const html = `
        <p><strong>Name:</strong> ${escapeHtml(item.name)}</p>
        <p><strong>Owner / Contact:</strong> ${escapeHtml(item.owner)}</p>
        <p><strong>Contact Number:</strong> ${escapeHtml(item.contactNumber || '')}</p>
        <p><strong>Email:</strong> ${escapeHtml(item.email)}</p>
        <p><strong>Industry:</strong> ${escapeHtml(item.industry)}</p>
        <p><strong>Address:</strong> ${escapeHtml(item.address)}</p>
        <p><strong>Status:</strong> ${escapeHtml(item.status)}</p>
        <p><strong>Date Registered:</strong> ${escapeHtml(item.dateRegistered)}</p>
      `;
      document.getElementById("viewBody").innerHTML = html;
      openModal(viewModal);
    }

    
    const editModal = document.getElementById("editModal");
    const closeEditBtnEl = document.getElementById("closeEditBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    closeEditBtnEl.onclick = cancelEditBtn.onclick = () => closeModal(editModal);

    const editForm = document.getElementById("editForm");
    let editingId = null;

    function openEdit(id) {
      const list = getData();
      const item = list.find(x => x.id === id);
      if (!item) return;
      editingId = id;
      document.getElementById("editName").value = item.name || "";
      document.getElementById("editOwner").value = item.owner || "";
      document.getElementById("editEmail").value = item.email || "";
      document.getElementById("editContact").value = item.contactNumber || "";
      document.getElementById("editIndustry").value = item.industry || "";
      document.getElementById("editAddress").value = item.address || "";
      openModal(editModal);
    }

    editForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (!editingId) return;
      const arr = getData();
      const idx = arr.findIndex(x => x.id === editingId);
      if (idx === -1) return;
      arr[idx].name = document.getElementById("editName").value.trim();
      arr[idx].owner = document.getElementById("editOwner").value.trim();
      arr[idx].email = document.getElementById("editEmail").value.trim();
      arr[idx].contactNumber = document.getElementById("editContact").value.trim();
      arr[idx].industry = document.getElementById("editIndustry").value;
      arr[idx].address = document.getElementById("editAddress").value.trim();
      saveData(arr);
      editingId = null;
      closeModal(editModal);
      renderTable();
    });


    const deleteModal = document.getElementById("deleteModal");
    const closeDeleteBtn = document.getElementById("closeDeleteBtn");
    const cancelDeleteBtnEl = document.getElementById("cancelDeleteBtn");
    closeDeleteBtn.onclick = cancelDeleteBtnEl.onclick = () => closeModal(deleteModal);

    let deletingId = null;
    function openDelete(id) {
      deletingId = id;
      const list = getData();
      const item = list.find(x => x.id === id);
      document.getElementById("deleteBody").innerHTML = `<p>Are you sure you want to delete <strong>${escapeHtml(item ? item.name : '')}</strong>?</p>`;
      openModal(deleteModal);
    }

    document.getElementById("confirmDeleteBtn").onclick = () => {
      if (!deletingId) return;
      let arr = getData();
      arr = arr.filter(x => x.id !== deletingId);
      saveData(arr);
      deletingId = null;
      closeModal(deleteModal);
      renderTable();
    };

  
    const verifyModal = document.getElementById("verifyModal");
    const closeVerifyBtn = document.getElementById("closeVerifyBtn");
    const cancelVerifyBtnEl = document.getElementById("cancelVerifyBtn");
    closeVerifyBtn.onclick = cancelVerifyBtnEl.onclick = () => closeModal(verifyModal);

    let verifyingId = null;
    function openVerify(id) {
      verifyingId = id;
      const list = getData();
      const item = list.find(x => x.id === id);
      document.getElementById("verifyBody").innerHTML = `<p>Verify <strong>${escapeHtml(item ? item.name : '')}</strong> as a trusted establishment?</p>`;
      openModal(verifyModal);
    }

    document.getElementById("confirmVerifyBtn").onclick = () => {
      if (!verifyingId) return;
      const arr = getData();
      const idx = arr.findIndex(x => x.id === verifyingId);
      if (idx !== -1) {
        arr[idx].status = "Verified";
        saveData(arr);
      }
      verifyingId = null;
      closeModal(verifyModal);
      renderTable();
    };

    
    function attachRowListenersToExisting() {
      document.querySelectorAll("#establishmentTable tbody tr").forEach(attachRowListeners);
    }

    document.querySelectorAll('.modal .close-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const modal = e.target.closest('.modal');
        if (modal) closeModal(modal);
      });
    });

    renderTable();
  </script>
</body>
</html>
