<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Industry Job Assignment | SKILLocal Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <link rel="stylesheet" href="industryass.css" />
</head>

<body class="dashboard-body">

  <aside class="sidebar">
    <h2 class="logo">SKILlocal</h2>
    <nav class="navbar flex-column">
      <ul class="navbar-nav w-100">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link toggle-menu">
            ‚öôÔ∏è Master Data
            <i class="fa-solid fa-chevron-down ms-auto"></i>
          </a>
          <ul class="submenu list-unstyled ms-3 show">
            <li><a class="submenu-item" href="barangay.html">üèò Barangay</a></li>
            <li><a class="submenu-item" href="establishments.html">üè¢ Establishment</a></li>
            <li><a class="submenu-item" href="industry.html">üè≠ Industry</a></li>
            <li><a class="submenu-item" href="skilledjob.html">üßë‚Äçüîß Skilled Job</a></li>
            <li><a class="submenu-item" href="skills.html">üß∞ Skills</a></li>
          </ul>
        </li>

        <li class="nav-item">
          <a href="#" class="nav-link toggle-menu">
            üß© Data Assignment
            <i class="fa-solid fa-chevron-down ms-auto"></i>
          </a>
          <ul class="submenu list-unstyled ms-3">
            <li><a class="submenu-item active" href="industryass.html">üè≠ Industry Job Assignment</a></li>
            <li><a class="submenu-item" href="jobskillsass.html">üß∞ Job Skills Assignment</a></li>
          </ul>
        </li>

        <li class="nav-item"><a href="users.html" class="nav-link">üë• Users</a></li>
        <li class="nav-item"><a href="matching.html" class="nav-link">üîç Job Matching</a></li>
        <li class="nav-item"><a href="vacancies.html" class="nav-link">üíº Job Vacancies</a></li>
        <li class="nav-item"><a href="applications.html" class="nav-link">üìÑ Applications</a></li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <div>
        <h1>üè≠ Industry Job Assignment</h1>
        <p>Manage industry‚Äìjob mappings for General Santos City.</p>
      </div>

      <div class="profile-container">
        <img src="image.jpg" alt="Profile" id="profile-icon" onclick="toggleProfileMenu()">
        <div id="profile-menu" class="profile-menu">
          <ul>
            <li><a href="profile.html">üë§ Profile</a></li>
            <li><a href="index.html"><i class="fa fa-sign-out-alt"></i> Logout</a></li>
          </ul>
        </div>
      </div>
    </header>

    <div class="top-controls mb-3">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by industry or job...">
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Industries</strong>
              <div class="small text-muted">Source list for all mappings.</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="btnAddIndustry">
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblIndustries">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Name</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Job Roles</strong>
              <div class="small text-muted">Manage all skilled job titles.</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="btnAddJob">
              <i class="bi bi-plus-lg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblJobs">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Title</th>
                    <th class="d-none d-lg-table-cell">Industry</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card ia-card shadow-sm h-100">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <strong>Industry ‚áÑ Job Assignments</strong>
              <div class="small text-muted">Links used for matching & vacancies.</div>
            </div>
            <button class="btn btn-sm btn-primary assign-btn" id="openAssignModalBtn">
              <i class="bi bi-link-45deg me-1"></i> Add
            </button>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="tblAssignments">
                <thead class="table-light sticky-top">
                  <tr>
                    <th style="width:70px">ID</th>
                    <th>Industry</th>
                    <th>Job</th>
                    <th>Status</th>
                    <th style="width:70px" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalIndustry" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formIndustry">
          <div class="modal-header">
            <h5 class="modal-title">Add Industry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="industryId">
            <div class="mb-3">
              <label class="form-label">Industry Name</label>
              <input class="form-control" id="industryName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-control" id="industryDesc" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalJob" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formJob">
          <div class="modal-header">
            <h5 class="modal-title">Add Job Role</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="jobId">
            <div class="mb-3">
              <label class="form-label">Job Title</label>
              <input class="form-control" id="jobTitle" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea class="form-control" id="jobDesc" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Industry (optional)</label>
              <select class="form-select" id="jobIndustry">
              </select>
              <div class="form-text">Optional if you will use the Assignment table for mapping.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal fade" id="modalAssign" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="formAssign">
          <div class="modal-header">
            <h5 class="modal-title">Add Industry ‚áÑ Job Assignment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="assignId">
            <div class="mb-3">
              <label class="form-label">Industry</label>
              <select class="form-select" id="assignIndustry" required></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Job</label>
              <select class="form-select" id="assignJob" required></select>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="assignActive" checked>
              <label class="form-check-label" for="assignActive">Active</label>
            </div>
            <div class="alert alert-light border-0 py-2 mb-0 small text-muted">
              Tip: Job list filters to selected industry if the job has an industry set, but you can still assign cross-industry.
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-light" data-bs-dismiss="modal" type="button">Cancel</button>
            <button class="btn btn-primary" type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function toggleProfileMenu() {
      const profileMenu = document.getElementById('profile-menu');
      profileMenu.classList.toggle('show');
    }

    document.querySelectorAll('.toggle-menu').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const submenu = btn.nextElementSibling;
        document.querySelectorAll('.submenu').forEach(list => {
          if (list !== submenu) list.classList.remove('show');
        });
        submenu.classList.toggle('show');
      });
    });

    const STORE_KEYS = {
      industries: 'skillocal_industries',
      jobs: 'skillocal_jobs',
      assigns: 'skillocal_assigns',
      idCounters: 'skillocal_idcounters'
    };

    const defaultData = {
      industries: [],
      jobs: [],
      assigns: [],
      idCounters: { industry: 0, job: 0, assign: 0 }
    };

    function loadStore() {
      const industries = JSON.parse(localStorage.getItem(STORE_KEYS.industries)) || defaultData.industries;
      const jobs = JSON.parse(localStorage.getItem(STORE_KEYS.jobs)) || defaultData.jobs;
      const assigns = JSON.parse(localStorage.getItem(STORE_KEYS.assigns)) || defaultData.assigns;
      const idCounters = JSON.parse(localStorage.getItem(STORE_KEYS.idCounters)) || defaultData.idCounters;
      return { industries, jobs, assigns, idCounters };
    }

    function saveStore({ industries, jobs, assigns, idCounters }) {
      localStorage.setItem(STORE_KEYS.industries, JSON.stringify(industries));
      localStorage.setItem(STORE_KEYS.jobs, JSON.stringify(jobs));
      localStorage.setItem(STORE_KEYS.assigns, JSON.stringify(assigns));
      localStorage.setItem(STORE_KEYS.idCounters, JSON.stringify(idCounters));
    }

    let state = loadStore();
    let assignIndustryChangeHandler = null; 

    const byId = id => document.getElementById(id);
    const modalIndustry = new bootstrap.Modal('#modalIndustry');
    const modalJob = new bootstrap.Modal('#modalJob');
    const modalAssign = new bootstrap.Modal('#modalAssign');

    function industryName(id) {
      return (state.industries.find(i => i.id === id) || {}).name || '‚Äî';
    }
    function jobTitle(id) {
      return (state.jobs.find(j => j.id === id) || {}).title || '‚Äî';
    }

    function renderIndustryOptions(selectEl, withEmpty = true) {
      selectEl.innerHTML = '';
      if (withEmpty) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '‚Äî None ‚Äî';
        selectEl.appendChild(opt);
      }
      state.industries.forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind.id;
        opt.textContent = `${ind.name}`;
        selectEl.appendChild(opt);
      });
    }

    function renderJobOptions(selectEl, filterIndustryId = null) {
      selectEl.innerHTML = '';

      if (!state.jobs.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No jobs available';
        selectEl.appendChild(opt);
        return;
      }

      const preferred = [];
      const others = [];

      state.jobs.forEach(job => {
        if (filterIndustryId && job.industryId === Number(filterIndustryId)) {
          preferred.push(job);
        } else {
          others.push(job);
        }
      });

      const ordered = [...preferred, ...others];

      ordered.forEach(job => {
        const opt = document.createElement('option');
        opt.value = job.id;
        const indName = job.industryId ? industryName(job.industryId) : 'No industry';
        opt.textContent = `${job.title} (${indName})`;
        selectEl.appendChild(opt);
      });
    }

    function renderIndustriesTable() {
      const tbody = byId('tblIndustries').querySelector('tbody');
      tbody.innerHTML = '';
      state.industries.forEach(ind => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ind.id}</td>
          <td>
            <div class="fw-semibold">${ind.name}</div>
            <div class="text-muted small">${ind.desc || ''}</div>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${ind.id}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${ind.id}"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderJobsTable() {
      const tbody = byId('tblJobs').querySelector('tbody');
      tbody.innerHTML = '';
      state.jobs.forEach(job => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${job.id}</td>
          <td>
            <div class="fw-semibold">${job.title}</div>
            <div class="text-muted small">${job.desc || ''}</div>
          </td>
          <td class="d-none d-lg-table-cell">
            ${job.industryId ? industryName(job.industryId) : '<span class="text-muted">‚Äî</span>'}
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${job.id}"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${job.id}"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAssignmentsTable() {
      const tbody = byId('tblAssignments').querySelector('tbody');
      const q = byId('searchInput').value.trim().toLowerCase();
      tbody.innerHTML = '';
      state.assigns
        .filter(a => {
          if (!q) return true;
          const iName = industryName(a.industryId).toLowerCase();
          const jTitle = jobTitle(a.jobId).toLowerCase();
          return iName.includes(q) || jTitle.includes(q);
        })
        .forEach(a => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${a.id}</td>
            <td>${industryName(a.industryId)}</td>
            <td>${jobTitle(a.jobId)}</td>
            <td>
              <span class="badge ${a.active ? 'bg-success' : 'bg-secondary'}">${a.active ? 'Active' : 'Inactive'}</span>
            </td>
            <td class="text-end">
              <button class="btn btn-sm btn-light me-1" data-action="edit" data-id="${a.id}"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-sm btn-light text-danger" data-action="del" data-id="${a.id}"><i class="bi bi-trash"></i></button>
            </td>
          `;
          tbody.appendChild(tr);
        });
    }

    byId('btnAddIndustry').addEventListener('click', () => {
      byId('industryId').value = '';
      byId('industryName').value = '';
      byId('industryDesc').value = '';
      byId('modalIndustry').querySelector('.modal-title').textContent = 'Add Industry';
      modalIndustry.show();
    });

    byId('formIndustry').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = byId('industryId').value;
      const name = byId('industryName').value.trim();
      if (!name) return;
      const desc = byId('industryDesc').value.trim();

      if (id) {
        const idx = state.industries.findIndex(i => i.id === Number(id));
        if (idx >= 0) {
          state.industries[idx].name = name;
          state.industries[idx].desc = desc;
        }
      } else {
        state.idCounters.industry += 1;
        state.industries.push({ id: state.idCounters.industry, name, desc });
      }
      saveStore(state);
      renderIndustryOptions(byId('jobIndustry'));
      renderIndustryOptions(byId('assignIndustry'), false);
      renderIndustriesTable();
      renderAssignmentsTable();
      modalIndustry.hide();
    });

    byId('tblIndustries').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') {
        const ind = state.industries.find(i => i.id === id);
        byId('industryId').value = ind.id;
        byId('industryName').value = ind.name;
        byId('industryDesc').value = ind.desc || '';
        byId('modalIndustry').querySelector('.modal-title').textContent = 'Edit Industry';
        modalIndustry.show();
      }
      if (action === 'del') {
        if (!confirm('Delete this industry? Related jobs/assignments will remain but may be orphaned.')) return;
        state.industries = state.industries.filter(i => i.id !== id);
        saveStore(state);
        renderIndustryOptions(byId('jobIndustry'));
        renderIndustryOptions(byId('assignIndustry'), false);
        renderIndustriesTable();
        renderJobsTable();
        renderAssignmentsTable();
      }
    });

    byId('btnAddJob').addEventListener('click', () => {
      byId('jobId').value = '';
      byId('jobTitle').value = '';
      byId('jobDesc').value = '';
      renderIndustryOptions(byId('jobIndustry'), true);
      byId('modalJob').querySelector('.modal-title').textContent = 'Add Job Role';
      modalJob.show();
    });

    byId('formJob').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = byId('jobId').value;
      const title = byId('jobTitle').value.trim();
      if (!title) return;
      const desc = byId('jobDesc').value.trim();
      const indVal = byId('jobIndustry').value;
      const industryId = indVal ? Number(indVal) : null;

      if (id) {
        const idx = state.jobs.findIndex(j => j.id === Number(id));
        if (idx >= 0) {
          state.jobs[idx].title = title;
          state.jobs[idx].desc = desc;
          state.jobs[idx].industryId = industryId;
        }
      } else {
        state.idCounters.job += 1;
        state.jobs.push({ id: state.idCounters.job, title, desc, industryId });
      }
      saveStore(state);
      renderJobsTable();
      renderAssignmentsTable();
      modalJob.hide();
    });

    byId('tblJobs').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') {
        const job = state.jobs.find(j => j.id === id);
        byId('jobId').value = job.id;
        byId('jobTitle').value = job.title;
        byId('jobDesc').value = job.desc || '';
        renderIndustryOptions(byId('jobIndustry'), true);
        byId('jobIndustry').value = job.industryId || '';
        byId('modalJob').querySelector('.modal-title').textContent = 'Edit Job Role';
        modalJob.show();
      }
      if (action === 'del') {
        if (!confirm('Delete this job role? Related assignments will remain but may be orphaned.')) return;
        state.jobs = state.jobs.filter(j => j.id !== id);
        saveStore(state);
        renderJobsTable();
        renderAssignmentsTable();
      }
    });

    function openAssignModal(editId = null) {
      renderIndustryOptions(byId('assignIndustry'), false);
      const industrySelect = byId('assignIndustry');
      const jobSelect = byId('assignJob');

      if (assignIndustryChangeHandler) {
        industrySelect.removeEventListener('change', assignIndustryChangeHandler);
      }

      assignIndustryChangeHandler = () => {
        const filter = industrySelect.value ? Number(industrySelect.value) : null;
        renderJobOptions(jobSelect, filter);
      };

      industrySelect.addEventListener('change', assignIndustryChangeHandler);

      byId('assignId').value = '';
      byId('assignActive').checked = true;

      if (editId) {
        const rec = state.assigns.find(a => a.id === editId);
        industrySelect.value = rec.industryId;
        assignIndustryChangeHandler();
        jobSelect.value = rec.jobId;
        byId('assignId').value = rec.id;
        byId('assignActive').checked = rec.active;
        byId('modalAssign').querySelector('.modal-title').textContent = 'Edit Assignment';
      } else {
        if (state.industries.length) {
          industrySelect.value = state.industries[0].id;
          assignIndustryChangeHandler();
        } else {
          renderJobOptions(jobSelect, null);
        }
        byId('modalAssign').querySelector('.modal-title').textContent = 'Add Industry ‚áÑ Job Assignment';
      }

      modalAssign.show();
    }

    byId('openAssignModalBtn').addEventListener('click', () => openAssignModal());

    byId('formAssign').addEventListener('submit', (e) => {
      e.preventDefault();
      const idVal = byId('assignId').value;
      const industryId = Number(byId('assignIndustry').value);
      const jobId = Number(byId('assignJob').value);
      const active = byId('assignActive').checked;

      const dup = state.assigns.find(a => a.industryId === industryId && a.jobId === jobId && a.id !== Number(idVal || 0));
      if (dup) {
        alert('This Industry ‚áÑ Job link already exists.');
        return;
      }

      if (idVal) {
        const idx = state.assigns.findIndex(a => a.id === Number(idVal));
        state.assigns[idx].industryId = industryId;
        state.assigns[idx].jobId = jobId;
        state.assigns[idx].active = active;
      } else {
        state.idCounters.assign += 1;
        state.assigns.push({
          id: state.idCounters.assign,
          industryId,
          jobId,
          active,
          date: new Date().toISOString()
        });
      }

      saveStore(state);
      renderAssignmentsTable();
      modalAssign.hide();
    });

    byId('tblAssignments').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === 'edit') openAssignModal(id);
      if (action === 'del') {
        if (!confirm('Delete this assignment?')) return;
        state.assigns = state.assigns.filter(a => a.id !== id);
        saveStore(state);
        renderAssignmentsTable();
      }
    });

    byId('searchInput').addEventListener('input', renderAssignmentsTable);

    (function init() {
      renderIndustriesTable();
      renderJobsTable();
      renderIndustryOptions(byId('jobIndustry'), true);
      renderIndustryOptions(byId('assignIndustry'), false);
      renderAssignmentsTable();
    })();
  </script>

</body>
</html>
